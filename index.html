<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Literary Escape</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="icon" type="image/x-icon" href="./media/icon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/f8c6d79c7d.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/common.css">
  <style>
    /* Base layout fixes */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    .main-content {
      min-height: calc(100vh - 160px);
      padding: 100px 0 40px 0;
    }
    
    /* Navbar improvements */
    .navbar {
      z-index: 1030;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      background: rgba(22, 66, 60, 0.95) !important;
      box-shadow: 0 2px 20px rgba(22, 66, 60, 0.3);
    }
    
    .navbar.fixed-top {
      position: fixed !important;
      top: 0;
      left: 0;
      right: 0;
    }
    
    /* Navbar text styling */
    .navbar .nav-link {
      color: #ffffff !important;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .navbar .nav-link:hover {
      color: #74b9ff !important;
      transform: translateY(-1px);
    }
    
    .navbar .dropdown-toggle {
      color: #ffffff !important;
    }
    
    .navbar .icon-link {
      color: #ffffff !important;
      text-decoration: none;
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .navbar .icon-link:hover {
      color: #74b9ff !important;
      transform: scale(1.1);
    }
    
    .navbar .icon-link i {
      color: #ffffff !important;
    }
    
    /* Audio control positioning */
    .audio-control {
      position: fixed;
      top: 90px;
      right: 20px;
      z-index: 1040;
      background: linear-gradient(135deg, #16423C 0%, #1a4f47 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(22, 66, 60, 0.3);
    }
    
    .audio-control:hover {
      background: linear-gradient(135deg, #1a4f47 0%, #2a5f57 100%);
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(22, 66, 60, 0.4);
    }
  </style>

</head>

<body>

  <audio id="bgMusic" loop>
    <source src="./media/Frédéric Chopin_ Nocturne in E-Flat Major, Op. 9, No. 2.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <button id="audioControl" class="audio-control" title="Audio Control">
    <i class="fas fa-volume-mute"></i>
  </button>

  <nav class="navbar navbar-expand-lg navbar-light bg-custom fixed-top" id="navbar">
    <div class="container-fluid">
      <!-- Brand Logo -->
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="media/icon.png" alt="Logo" width="50" height="50" class="me-2">
        <span>LITERARY ESCAPE</span>
      </a>

      <!-- Toggler for Mobile View -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Navbar Links and Search Bar -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="shopDropdown" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">Shop</a>
            <ul class="dropdown-menu" aria-labelledby="shopDropdown">
              <li><a class="dropdown-item" href="fiction.html">Fiction</a></li>
              <li><a class="dropdown-item" href="non-fiction.html">Non-Fiction</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about-us.html">About Us</a>
          </li>
        </ul>

        <!-- Search Bar -->
        <form class="d-flex mx-3" onsubmit="handleSearch(event)">
          <div class="search-wrapper w-100">
            <input class="form-control pr-5" type="search" placeholder="Search" aria-label="Search" id="searchInput">
            <button class="btn mx-0" title="search-btn" type="submit"><i class="bi bi-search"></i></button>
          </div>
        </form>

        <!-- Icons -->
        <div class="d-flex align-items-center nav-icons">
          <a href="favorites.html" class="icon-link" title="Favorites">
            <i class="fa-solid fa-heart"></i>
            <span id="favorites-count" class="cart-count">0</span>
          </a>
          <a href="cart.html" class="icon-link" title="Shopping Cart">
            <i class="fa-solid fa-cart-shopping"></i>
            <span id="cart-count" class="cart-count">0</span>
          </a>
          <a href="account.html" class="icon-link" title="Account"><i class="fa-solid fa-user"></i></a>
        </div>
      </div>
    </div>
  </nav>

  <section class="hero">
    <div class="hero-content">
      <h2>WHERE <span>QUALITY</span> MEETS <span class="low-price">LOW PRICE</span></h2>
      <button class="explore-link"><a style="text-decoration: none; color: #ffffff;" href="#">Explore ↓</a></button>
    </div>
    <div class="book-covers">
      <img src="./media/Unrivaled.png" alt="Book 1 Cover">
      <img src="./media/LOCKED1.png" alt="Book 2 Cover">
      <img src="./media/Reckoning.png" alt="Book 3 Cover">
    </div>
  </section>

  <!-- Featured Section -->
  <section id="featured-section" style="display: block;" class="d-flex">
    <div class="container mt-0 d-flex align-items-center">
      <div id="genreCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          <h3 style="color: white;" class="text-center">Shop by Genre</h3>
          <!-- First slide -->
          <div class="carousel-item active">
            <div class="row">
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="fiction.html#scienceFictionSection">
                  <div class="genre-card">
                    <img src="media/Genres/science fiction 3.JPG" class="img-fluid" alt="Science Fiction">
                    <div class="genre-overlay">
                      <h4>Science Fiction</h4>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="non-fiction.html#philosophySection">
                  <div class="genre-card">
                    <img src="media/Genres/Philosophy.JPG" class="img-fluid" alt="Philosophy">
                    <div class="genre-overlay">
                      <h4>Philosophy</h4>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="fiction.html#magicRealismSection">
                  <div class="genre-card">
                    <img src="media/Genres/Magic Realism.JPG" class="img-fluid" alt="Magic Realism">
                    <div class="genre-overlay">
                      <h4>Magic Realism</h4>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="non-fiction.html#politicsSection">
                  <div class="genre-card">
                    <img src="media/Genres/Politics.JPG" class="img-fluid" alt="Politics">
                    <div class="genre-overlay">
                      <h4>Politics</h4>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>
          <!-- Second slide -->
          <div class="carousel-item">
            <div class="row">
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="non-fiction.html#trueCrimeSection">
                  <div class="genre-card">
                    <img src="media/Genres/True crime.JPG" class="img-fluid" alt="True Crime">
                    <div class="genre-overlay">
                      <h4>True Crime</h4>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="fiction.html#mysterySection">
                  <div class="genre-card">
                    <img src="media/Genres/mystery.JPG" class="img-fluid" alt="Mystery">
                    <div class="genre-overlay">
                      <h4>Mystery</h4>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="non-fiction.html#selfHelpSection">
                  <div class="genre-card">
                    <img src="media/Genres/Self help.JPG" class="img-fluid" alt="Self Help">
                    <div class="genre-overlay">
                      <h4>Self Help</h4>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-12 col-md-3">
                <a class="text-decoration-none" href="fiction.html#crimeSection">
                  <div class="genre-card">
                    <img src="media/Genres/Crime.JPG" class="img-fluid" alt="Crime">
                    <div class="genre-overlay">
                      <h4>Crime</h4>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
        <!-- Controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#genreCarousel" data-bs-slide="prev"
          style="margin-left: -120px;">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#genreCarousel" data-bs-slide="next"
          style="margin-right: -120px;">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Showcase Section -->
  <section id="showcase-section" style="padding-top: 30px;">

    <div class="container">
      <div class="row text-start my-5">
        <div class="d-flex align-items-center gap-3">
          <h4 class="mb-0">Discover</h4>
          <div class="section-line flex-grow-1"></div>
        </div>
      </div>
      <div id="discoverBooks" class="products-container row">
      </div>
  </section>

  <!-- Dedicated Section-->
  <section id="dedicated-section">
    <h2>DEDICATED FOR BOOKAHOLICS</h2>
    <h5>By Fellow Enthusiasts</h5>
    <p>Started 2024</p>
    <button id="videoBtn" class="video-btn" onclick="showVideoContainer()">Watch Video</button>

    <div id="videoContainer">
      <video width="1920" height="1080" preload="auto" controls>
        <source src="./media/about-us.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <button id="exitFullscreen" title="Exit Fullscreen" onclick="closeVideoContainer()">
        <i class="fa-solid fa-xmark" style="color: #ffffff;"></i>
      </button>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <a href="https://www.facebook.com/" class="text-decoration-none" style="color: white;"><i
        class="fa-brands fa-facebook"></i></a>
    <a href="https://www.instagram.com/" class="text-decoration-none" style="color: white;"><i
        class="fa-brands fa-instagram"></i></a>
  </footer>

  <script>
    const videoBtn = document.getElementById('videoBtn');
    const videoContainer = document.getElementById('videoContainer');
    const video = document.querySelector('video');
    const navbar = document.getElementById('navbar');
    const exitFullscreen = document.getElementById('exitFullscreen');
    var featuredSection = document.getElementById("featured-section");

    document.addEventListener('DOMContentLoaded', async function () {
      // Initialize explore button
      const exploreLink = document.querySelector('.explore-link');
      exploreLink.addEventListener('click', function (e) {
        e.preventDefault();
        const showcaseSection = document.getElementById('showcase-section');
        if (showcaseSection) {
          showcaseSection.scrollIntoView({ behavior: 'smooth' });
        }
      });

      // Initialize UI components - always update cart count
      try {
        if (dbBookDisplay && typeof dbBookDisplay.updateCartCount === 'function') {
          await dbBookDisplay.updateCartCount();
        }
        await updateFavoritesCount();
        updateNavbarAccountLink();
      } catch (error) {
        console.warn('UI component update failed:', error);
      }
      
      // Always load discover books regardless of login status
      await displayDiscoverBooks();
    });

    function getInitials(name) {
      return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
    }

    function updateNavbarAccountLink() {
      const accountIcon = document.querySelector('.nav-icons .icon-link:last-child');
      if (accountIcon && api && api.isLoggedIn && api.isLoggedIn()) {
        accountIcon.href = 'account-dashboard.html';
        const user = api.getCurrentUser();
        if (user) {
          // Replace the icon with user initials
          const userInitials = getInitials(user.username);
          accountIcon.innerHTML = userInitials;
          accountIcon.className = 'navbar-user-avatar';
          accountIcon.title = `Logged in as ${user.username}`;
        }
      } else if (accountIcon) {
        // Ensure link goes to login page when not logged in
        accountIcon.href = 'account.html';
        accountIcon.innerHTML = '<i class="fa-solid fa-user" style="color: #ffffff;"></i>';
        accountIcon.className = 'icon-link';
        accountIcon.title = 'Login or Sign Up';
      }
    }

    function showVideoContainer() {
      videoContainer.style.display = 'block';
      document.body.classList.add('video-open');
      document.body.style.overflow = 'hidden';
      navbar.style.zIndex = 0;
      const audio = document.getElementById('bgMusic');
      const audioIcon = document.querySelector('#audioControl i');
      if (audio) audio.pause();
      if (audioIcon) audioIcon.classList.add('fa-volume-mute');
      video.play();
    }

    function closeVideoContainer() {
      video.pause();
      video.currentTime = 0;
      videoContainer.style.display = 'none';
      document.body.classList.remove('video-open');
      document.body.style.overflow = 'auto';
      navbar.style.zIndex = 9999;
    }

    async function displayDiscoverBooks() {
      const container = document.querySelector('#discoverBooks');
      if (!container) {
        console.error('Discover books container not found');
        return;
      }

      // Show loading state
      container.innerHTML = '<div class="col-12"><p class="text-center">Loading discover books...</p></div>';

      try {
        let allBooks = [];
        
        console.log('Starting book loading process...');
        
        // Always try to load books regardless of login status
        if (typeof api !== 'undefined' && api && typeof api.getBooks === 'function') {
          try {
            console.log('Attempting to load books...');
            allBooks = await api.getBooks({});
            console.log(`Loaded ${allBooks.length} books from API`);
          } catch (apiError) {
            console.warn('API call failed:', apiError);
          }
        }

        // Try dbBookDisplay methods if direct API didn't work
        if (allBooks.length === 0 && dbBookDisplay) {
          if (typeof dbBookDisplay.loadAllBooks === 'function') {
            try {
              console.log('Attempting loadAllBooks...');
              allBooks = await dbBookDisplay.loadAllBooks();
              console.log(`Loaded ${allBooks.length} books via loadAllBooks`);
            } catch (error) {
              console.warn('loadAllBooks failed:', error);
            }
          }
        }
        
        // Use sample books if nothing else worked
        if (allBooks.length === 0) {
          console.log('No books loaded from API, using sample books');
          allBooks = getSampleBooks();
          console.log(`Using ${allBooks.length} sample books`);
        }

        console.log(`Final book count: ${allBooks.length}`);

        // Process books and get user-specific randomized selection
        const processedBooks = processDiscoverBooks(allBooks);
        const randomizedBooks = getRandomizedBooksForUser(processedBooks);
        
        console.log(`Displaying ${randomizedBooks.length} randomized books`);
        
        if (randomizedBooks.length === 0) {
          container.innerHTML = '<div class="col-12"><p class="text-center text-muted">No discover books available</p></div>';
        } else {
          // Use standard database book display
          if (dbBookDisplay && typeof dbBookDisplay.displayBooks === 'function') {
            dbBookDisplay.displayBooks(randomizedBooks, container);
          } else {
            // Fallback to simple cards if database display is not available
            container.innerHTML = randomizedBooks.map(book => createSimpleBookCard(book)).join('');
          }
          console.log('Books rendered successfully');
        }

      } catch (error) {
        console.error('Critical error in displayDiscoverBooks:', error);
        
        // Emergency fallback
        try {
          console.log('Using emergency fallback');
          const emergencyBooks = getSampleBooks();
          const randomizedEmergency = getRandomizedBooksForUser(emergencyBooks);
          
          // Use standard database book display for emergency fallback too
          if (dbBookDisplay && typeof dbBookDisplay.displayBooks === 'function') {
            dbBookDisplay.displayBooks(randomizedEmergency, container);
          } else {
            container.innerHTML = randomizedEmergency.map(book => createSimpleBookCard(book)).join('');
          }
        } catch (emergencyError) {
          console.error('Emergency fallback failed:', emergencyError);
          container.innerHTML = `
            <div class="col-12">
              <div class="text-center">
                <p class="text-muted mb-3">Unable to load book catalog at the moment.</p>
                <button class="btn btn-primary" onclick="displayDiscoverBooks()">Try Again</button>
              </div>
            </div>
          `;
        }
      }
    }

    function getSampleBooks() {
      // Expanded sample books with more variety
      return [
        {
          id: 'sample-1',
          title: 'The Great Adventure',
          author: 'John Smith',
          genre: 'Fiction',
          price: 19.99,
          image_url: './media/placeholder-book.jpg',
          description: 'An exciting tale of adventure and discovery.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-2',
          title: 'Mystery of the Lost City',
          author: 'Jane Doe',
          genre: 'Mystery',
          price: 24.99,
          image_url: './media/placeholder-book.jpg',
          description: 'A thrilling mystery that will keep you guessing.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-3',
          title: 'Science and Innovation',
          author: 'Dr. Robert Johnson',
          genre: 'Non-Fiction',
          price: 29.99,
          image_url: './media/placeholder-book.jpg',
          description: 'Exploring the latest in scientific discoveries.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-4',
          title: 'Love in Paris',
          author: 'Marie Claire',
          genre: 'Romance',
          price: 16.99,
          image_url: './media/placeholder-book.jpg',
          description: 'A romantic story set in the beautiful city of Paris.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-5',
          title: 'Future Worlds',
          author: 'Alex Turner',
          genre: 'Science Fiction',
          price: 22.99,
          image_url: './media/placeholder-book.jpg',
          description: 'Exploring possible futures and alien worlds.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-6',
          title: 'The Wizard\'s Quest',
          author: 'Emma Wilson',
          genre: 'Fantasy',
          price: 18.99,
          image_url: './media/placeholder-book.jpg',
          description: 'A magical journey through enchanted lands.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-7',
          title: 'Digital Revolution',
          author: 'Tech Guru',
          genre: 'Technology',
          price: 27.99,
          image_url: './media/placeholder-book.jpg',
          description: 'How technology is changing our world.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-8',
          title: 'Cooking Mastery',
          author: 'Chef Master',
          genre: 'Cooking',
          price: 21.99,
          image_url: './media/placeholder-book.jpg',
          description: 'Master the art of culinary excellence.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-9',
          title: 'Historical Chronicles',
          author: 'History Professor',
          genre: 'History',
          price: 25.99,
          image_url: './media/placeholder-book.jpg',
          description: 'Fascinating stories from the past.',
          cover: './media/placeholder-book.jpg'
        },
        {
          id: 'sample-10',
          title: 'Mind and Body',
          author: 'Wellness Expert',
          genre: 'Self Help',
          price: 23.99,
          image_url: './media/placeholder-book.jpg',
          description: 'Achieve balance in life and wellness.',
          cover: './media/placeholder-book.jpg'
        }
      ];
    }

    function createSimpleBookCard(book) {
      const bookTitle = book.title || 'Unknown Title';
      const bookAuthor = book.author || 'Unknown Author';
      const bookPrice = book.price ? parseFloat(book.price).toFixed(2) : '0.00';
      const bookId = book.id || Math.random().toString(36).substr(2, 9);
      
      // Better image handling
      let imageElement;
      if (book.cover && book.cover !== './media/placeholder-book.jpg') {
        imageElement = `<img src="${book.cover}" alt="${bookTitle}" class="img-fluid products" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`;
      } else if (book.image_url && book.image_url !== './media/placeholder-book.jpg') {
        imageElement = `<img src="${book.image_url}" alt="${bookTitle}" class="img-fluid products" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`;
      } else {
        imageElement = `<img src="https://via.placeholder.com/200x300/8B4513/FFFFFF?text=${encodeURIComponent(bookTitle)}" alt="${bookTitle}" class="img-fluid products" style="display: none;" />`;
      }
      
      return `
        <div class="col-md-3 mb-4">
          <div class="product-box" data-product-id="${bookId}" onmouseenter="this.classList.add('is-hover')" onmouseleave="this.classList.remove('is-hover')">
            <div class="product-inner-box position-relative">
              <div class="icons position-absolute">
                <button class="btn-favorite" data-book-id="${bookId}" onclick="handleFavoriteClick('${bookId}')">
                  <i class="fas fa-heart"></i>
                </button>
              </div>
              <a href="product.html?id=${bookId}" class="product-link">
                ${imageElement}
                <div class="discover-book-image" style="display: ${book.cover || book.image_url ? 'none' : 'flex'};">
                  <div>
                    <div style="font-size: 16px; margin-bottom: 10px;">📚</div>
                    <div style="font-size: 14px; font-weight: bold;">${bookTitle}</div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">${bookAuthor}</div>
                  </div>
                </div>
              </a>
              <div class="cart-btn">
                <button class="btn btn-white shadow-sm rounded-pill" onclick="handleCartClick('${bookId}')">
                  <i class="fa-solid fa-cart-shopping me-1"></i> Add to Cart
                </button>
              </div>
            </div>
            <div class="product-info">
              <div class="product-name">
                <h4 title="${bookTitle}">${bookTitle}</h4>
                <p class="text-muted small" title="${bookAuthor}">${bookAuthor}</p>
              </div>
              <div class="product-price">
                ₱<span>${bookPrice}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Add simple handlers for buttons
    function handleCartClick(bookId) {
        if (typeof api !== 'undefined' && api.isLoggedIn && api.isLoggedIn()) {
            // User is logged in, try to add to cart
            if (dbBookDisplay && typeof dbBookDisplay.addToCart === 'function') {
                dbBookDisplay.addToCart(bookId);
            } else {
                alert('Added to cart! (Feature in development)');
            }
        } else {
            // User not logged in - redirect immediately
            window.location.href = 'account.html';
        }
    }

    function handleFavoriteClick(bookId) {
      if (typeof api !== 'undefined' && api.isLoggedIn && api.isLoggedIn()) {
        // User is logged in, try to toggle favorite
        if (dbBookDisplay && typeof dbBookDisplay.toggleFavorite === 'function') {
          const button = document.querySelector(`[data-book-id="${bookId}"].btn-favorite`);
          dbBookDisplay.toggleFavorite(bookId, button);
        } else {
          alert('Added to favorites! (Feature in development)');
        }
      } else {
        // User not logged in - redirect immediately
        window.location.href = 'account.html';
      }
    }

    function processDiscoverBooks(allBooks) {
      return allBooks.map(book => {
        // Create a copy of the book to avoid modifying the original
        const processedBook = { ...book };
        
        // If book only has "Discover" genre, assign appropriate genre based on other properties
        if (processedBook.genre === 'Discover' || (Array.isArray(processedBook.genres) && processedBook.genres.includes('Discover') && processedBook.genres.length === 1)) {
          processedBook.genre = assignApplicableGenre(processedBook);
        }
        
        return processedBook;
      });
    }

    function assignApplicableGenre(book) {
      // Genre assignment logic based on book properties
      const title = (book.title || '').toLowerCase();
      const description = (book.description || '').toLowerCase();
      const author = (book.author || '').toLowerCase();
      
      // Define genre keywords
      const genreKeywords = {
        'Science Fiction': ['space', 'alien', 'future', 'robot', 'technology', 'sci-fi', 'galaxy', 'planet'],
        'Mystery': ['detective', 'murder', 'crime', 'investigation', 'clue', 'mystery', 'suspect', 'solve'],
        'Romance': ['love', 'heart', 'romance', 'passion', 'relationship', 'wedding', 'kiss'],
        'Fantasy': ['magic', 'wizard', 'dragon', 'fantasy', 'spell', 'kingdom', 'quest', 'sword'],
        'Thriller': ['thriller', 'suspense', 'danger', 'chase', 'escape', 'threat', 'tension'],
        'Horror': ['horror', 'ghost', 'haunted', 'scary', 'fear', 'nightmare', 'dark', 'evil'],
        'Historical Fiction': ['history', 'war', 'century', 'historical', 'past', 'ancient', 'medieval'],
        'Biography': ['life', 'biography', 'memoir', 'story of', 'born', 'died', 'famous'],
        'Self Help': ['self', 'help', 'improve', 'guide', 'success', 'motivation', 'advice', 'tips'],
        'Philosophy': ['philosophy', 'wisdom', 'truth', 'meaning', 'existence', 'thought', 'mind']
      };
      
      // Check title, description, and author for genre keywords
      const searchText = `${title} ${description} ${author}`;
      
      for (const [genre, keywords] of Object.entries(genreKeywords)) {
        if (keywords.some(keyword => searchText.includes(keyword))) {
          return genre;
        }
      }
      
      // Fallback genres based on common patterns
      if (title.includes('the') && (description.includes('story') || description.includes('tale'))) {
        return Math.random() > 0.5 ? 'Fiction' : 'Literary Fiction';
      }
      
      // Default fallback
      const defaultGenres = ['Fiction', 'Non-Fiction', 'Contemporary', 'Literary Fiction'];
      return defaultGenres[Math.floor(Math.random() * defaultGenres.length)];
    }

    function getRandomizedBooksForUser(books) {
      // Get user-specific seed for consistent randomization per user
      let userSeed = getUserSeed();
      
      // Create a seeded random function
      const seededRandom = createSeededRandom(userSeed);
      
      // Shuffle books using seeded random
      const shuffledBooks = shuffleArrayWithSeed(books, seededRandom);
      
      // Return a subset of books (e.g., 8-12 books)
      const displayCount = Math.floor(seededRandom() * 5) + 8; // 8-12 books
      return shuffledBooks.slice(0, Math.min(displayCount, shuffledBooks.length));
    }

    function getUserSeed() {
      // Get user-specific seed
      if (typeof api !== 'undefined' && api && api.isLoggedIn && api.isLoggedIn()) {
        const user = api.getCurrentUser();
        if (user && user.id) {
          // Use user ID as base for seed
          return hashStringToNumber(user.id.toString() + user.email);
        }
      }
      
      // For non-logged-in users, use date-based seed that changes daily
      const today = new Date();
      const dateString = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
      return hashStringToNumber(dateString);
    }

    function hashStringToNumber(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      return Math.abs(hash);
    }

    function createSeededRandom(seed) {
      return function() {
        seed = (seed * 9301 + 49297) % 233280;
        return seed / 233280;
      };
    }

    function shuffleArrayWithSeed(array, randomFunc) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(randomFunc() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Handle search
    function handleSearch(event) {
        event.preventDefault();
        const query = document.getElementById('searchInput').value.trim();
        if (query) {
            window.location.href = `search-results.html?q=${encodeURIComponent(query)}`;
        }
    }
  </script>

  <script src="js/api-client.js"></script>
  <script src="js/navbar-counts.js"></script>
  <script src="js/database-book-display.js"></script>
  <!-- Remove conflicting scripts that might interfere with notifications -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>